#!/bin/bash

NAMESPACE="your-namespace"
LOCAL_DIR="./downloaded_appsettings"

echo "=== Starting pod file collection for namespace: $NAMESPACE ==="
mkdir -p "$LOCAL_DIR"

# Get all pods and their "app" label if present, otherwise pod name prefix
kubectl get pods -n "$NAMESPACE" -o custom-columns="POD:.metadata.name,APP:.metadata.labels.app" --no-headers | while read -r pod app; do
    base_name="$app"
    if [[ "$base_name" == "<none>" || -z "$base_name" ]]; then
        # Fallback: take first 2 segments of pod name (assuming pattern: name-hash)
        base_name=$(echo "$pod" | cut -d'-' -f1-2)
    fi

    # Only keep first pod we see for each base_name
    if [[ -n "${seen[$base_name]}" ]]; then
        continue
    fi
    seen[$base_name]=1

    echo ""
    echo "---------------------------------------------"
    echo "[INFO] Processing app/service: $base_name"
    echo "[INFO] Selected pod: $pod"

    # Search recursively for appsettings.* (to avoid path issues)
    files=$(kubectl exec -n "$NAMESPACE" "$pod" -- sh -c "find / -type f -name 'appsettings.*' 2>/dev/null" || true)

    if [[ -z "$files" ]]; then
        echo "[INFO] No appsettings.* files found in pod: $pod"
        continue
    fi

    echo "[INFO] Found files:"
    echo "$files" | while read -r f; do
        echo "       - $f"
    done

    # Copy files with service_name prefix
    while read -r f; do
        fname=$(basename "$f")
        dest_file="$LOCAL_DIR/${base_name}_$fname"
        echo "[ACTION] Copying '$f' from pod '$pod' to '$dest_file'..."
        kubectl cp "$NAMESPACE/$pod:$f" "$dest_file"
        if [[ $? -eq 0 ]]; then
            echo "[SUCCESS] File copied: $dest_file"
        else
            echo "[ERROR] Failed to copy: $f"
        fi
    done <<< "$files"
done

echo ""
echo "=== Completed pod file collection ==="
echo "Files saved in: $LOCAL_DIR"
