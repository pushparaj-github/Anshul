# ========= CONFIGURATION ============
$tenantId = "<your-tenant-id>"
$clientId = "<your-client-id>"
$clientSecret = "<your-client-secret>"
$subscriptionId = "<your-subscription-id>"
$resourceGroupName = "<your-resource-group-name>"
$dataFactoryName = "<your-data-factory-name>"
# ====================================

# Get access token
$body = @{
    grant_type    = "client_credentials"
    client_id     = $clientId
    client_secret = $clientSecret
    scope         = "https://management.azure.com/.default"
}
$tokenResponse = Invoke-RestMethod -Method Post -Uri "https://login.microsoftonline.com/$tenantId/oauth2/v2.0/token" -Body $body
$accessToken = $tokenResponse.access_token
$headers = @{ Authorization = "Bearer $accessToken" }

# Helper function to delete resources of a type
function Delete-ADFResources {
    param (
        [string]$resourceType,
        [string]$apiVersion = "2018-06-01"
    )

    $baseUri = "https://management.azure.com/subscriptions/$subscriptionId/resourceGroups/$resourceGroupName/providers/Microsoft.DataFactory/factories/$dataFactoryName/$resourceType?api-version=$apiVersion"
    
    try {
        $list = Invoke-RestMethod -Method Get -Uri $baseUri -Headers $headers
        foreach ($item in $list.value) {
            $name = $item.name
            $delUri = "https://management.azure.com$($item.id)?api-version=$apiVersion"
            Invoke-RestMethod -Method Delete -Uri $delUri -Headers $headers
            Write-Host "Deleted $resourceType: $name"
        }
    } catch {
        Write-Warning "Failed to list/delete $resourceType - $_"
    }
}

# ===== DELETE IN SAFE ORDER =====
# 1. Triggers (stop & delete)
function Stop-And-Delete-Triggers {
    $triggerUri = "https://management.azure.com/subscriptions/$subscriptionId/resourceGroups/$resourceGroupName/providers/Microsoft.DataFactory/factories/$dataFactoryName/triggers?api-version=2018-06-01"
    $triggers = Invoke-RestMethod -Method Get -Uri $triggerUri -Headers $headers
    foreach ($trigger in $triggers.value) {
        $triggerName = $trigger.name
        $stopUri = "https://management.azure.com/subscriptions/$subscriptionId/resourceGroups/$resourceGroupName/providers/Microsoft.DataFactory/factories/$dataFactoryName/triggers/$triggerName/stop?api-version=2018-06-01"
        Invoke-RestMethod -Method Post -Uri $stopUri -Headers $headers -ErrorAction SilentlyContinue
        $delUri = "https://management.azure.com$($trigger.id)?api-version=2018-06-01"
        Invoke-RestMethod -Method Delete -Uri $delUri -Headers $headers
        Write-Host "Stopped & deleted trigger: $triggerName"
    }
}

# Run all deletions
Stop-And-Delete-Triggers
Delete-ADFResources -resourceType "pipelines"
Delete-ADFResources -resourceType "datasets"
Delete-ADFResources -resourceType "linkedservices"

Write-Host "âœ… All Data Factory resources deleted."
